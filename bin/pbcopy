#!/usr/bin/env zsh
#
# Send stdin to the terminal's clipboard, if it has OCS 52 support.

print_usage() {
    echo "Send stdin to the terminal's clipboard" >&2
    echo "Usage: echo text | ${0:t} [-n]" >&2
    echo "  -n    Strip whitespace" >&2
    exit 1
}

ocs52_send() {
    if [[ -t 1 && "$TERM" != dumb ]]; then
        printf "\033]52;c;%s\007" "$(base64 | tr -d '\n')"
    else
        echo "Warning: Terminal may not support OSC 52 clipboard" >&2
    fi
}

send_to_clipboard() {
    if [[ $OSTYPE == darwin* ]]; then
        shift
        exec /usr/bin/pbcopy "$@"
    else
        ocs52_send
    fi
}

strip_whitespace() {
    if (( $+commands[perl] )); then
        perl -0777 -pe 's/^\s+//; s/\s+$//'
    else
        # Assume that we have GNU sed if perl is not installed
        sed -z 's/^[[:space:]]*//;s/[[:space:]]*$//'
    fi
}

case $1 in
    -h) print_usage ;;
    -n) strip_whitespace | send_to_clipboard "$@" ;;
    *)  send_to_clipboard "$@"
esac
